<section class="book-details-page">
  <div class="page-gutter">
    <div class="content">

      <!-- ===== Top bar: title + share button + back link ===== -->
      <div class="topbar">
        <div class="title-wrap">
          <!-- Section title (reusable component) -->
          <app-section-title [title]="title()"></app-section-title>

          <!-- Share button -->
          <div class="share-wrap">
            <button type="button" class="styled-button secondary btn-sm btn-icon"
                    (click)="share()" aria-haspopup="dialog" aria-controls="share-dialog">
              <span class="icon i-share" aria-hidden="true"></span>
              <span>Partager</span>
            </button>
          </div>
        </div>

        <!-- Back link to catalog -->
        <a class="back-link" routerLink="/catalogue">Retourner sur le catalogue&nbsp;›</a>
      </div>

      <!-- ===== Grid with cover on the left and metadata on the right ===== -->
      <div class="grid">
        <!-- Left column: book cover -->
        <div class="left">
          <figure class="cover">
            <!-- If cover exists, display it; otherwise show placeholder -->
            <ng-container *ngIf="coverUrl(); else placeholder">
              <img [ngSrc]="coverUrl()!" [alt]="title()" width="600" height="375" loading="lazy" />
            </ng-container>
            <ng-template #placeholder>
              <img ngSrc="assets/images/placeholder.webp" [alt]="title()" width="600" height="375" loading="lazy" />
            </ng-template>
          </figure>
        </div>

        <!-- Right column: metadata and actions -->
        <div class="right">
          <!-- Metadata (definition list) -->
          <dl class="props props--top">
            <div><dt>ISBN</dt><dd>{{ isbn() }}</dd></div>
            <div><dt>Date de publication</dt><dd>{{ date() }}</dd></div>
            <div><dt>Auteur</dt><dd>{{ author() }}</dd></div>
            <div><dt>Éditeur</dt><dd>{{ publisher() }}</dd></div>
            <div><dt>Genre</dt><dd>{{ genres() }}</dd></div>

            <!-- Availability -->
            <div>
              <dt>État</dt>
              <dd>
                <span class="status" [class.is-ok]="isAvailable()" [class.is-ko]="!isAvailable()">
                  {{ availabilityLabel() }}
                </span>
              </dd>
            </div>

            <!-- Tags -->
            <div>
              <dt>Tags</dt>
              <dd>
                <ng-container *ngIf="taglist(); else noTags">
                  <ul class="tags">
                    <li *ngFor="let t of taglist()!.split(',')">{{ t.trim() }}</li>
                  </ul>
                </ng-container>
                <ng-template #noTags>—</ng-template>
              </dd>
            </div>
          </dl>

          <!-- ===== Call-to-actions (borrow / reserve) ===== -->
          <div *ngIf="isAuthenticated$ | async; else guestCta" class="cta-row cta-right">

            <!-- Borrow button -->
            <button
              class="styled-button secondary btn-lg btn-icon"
              type="button"
              (click)="borrow()"
              [disabled]="borrowing() || hasActiveLoan() || !isAvailable()"
              [attr.title]="hasActiveLoan() && loanDue() ? 'À rendre avant ' + (loanDue() | date:'dd/MM/yyyy') : null">
              <span class="icon i-book-open" aria-hidden="true"></span>
              <span class="btn-label" *ngIf="!borrowing(); else borrowingTpl">
                <strong>{{ hasActiveLoan() ? 'Emprunt en cours' : 'Emprunter' }}</strong>
                <small *ngIf="hasActiveLoan() && loanDue()">retour {{ loanDue() | date:'dd/MM/yyyy' }}</small>
              </span>
            </button>
            <ng-template #borrowingTpl>Traitement…</ng-template>

            <!-- Reserve button -->
            <button
              class="styled-button outline btn-lg btn-icon"
              type="button"
              (click)="reserve()"
              [disabled]="isAvailable() || reserving() || hasReserved() || hasActiveLoan()"
              [attr.title]="
                isAvailable() ? 'Le livre est disponible : empruntez-le' :
                hasActiveLoan() ? 'Vous avez déjà un emprunt en cours sur ce livre' :
                hasReserved() ? 'Réservation déjà enregistrée' : null
              ">
              <span class="icon i-calendar-add" aria-hidden="true"></span>
              <span class="btn-label">
                <strong *ngIf="!hasReserved(); else reservedTpl">
                  {{ reserving() ? 'Traitement…' : 'Réserver' }}
                </strong>
              </span>
            </button>
            <ng-template #reservedTpl>Réservé</ng-template>
          </div>

          <!-- Guest users: message instead of actions -->
          <ng-template #guestCta>
            <p class="cta-guest">
              <a routerLink="/connexion">Connectez-vous</a>
              pour réserver ou emprunter ce livre.
            </p>
          </ng-template>
        </div>
      </div>

      <!-- ===== Below grid: description + location ===== -->
      <div class="below">
        <!-- Description -->
        <div class="description" *ngIf="description() as desc">
          <h4>Description</h4>
          <p>{{ desc }}</p>
        </div>

        <!-- Location (floor, aisle, shelf, level) -->
        <dl class="props props--loc">
          <div><dt>Étage</dt><dd>{{ floor() }}</dd></div>
          <div><dt>Allée</dt><dd>{{ aisle() }}</dd></div>
          <div><dt>Rayon</dt><dd>{{ rayon() }}</dd></div>
          <div><dt>Étagère</dt><dd>{{ shelf() }}</dd></div>
        </dl>
      </div>
    </div>

    <!-- ===== Not found case ===== -->
    <div class="empty" *ngIf="notFound()">
      <img loading="lazy" ngSrc="assets/images/empty.svg" alt="" width="64" height="64" />
      <p>Oups… ce livre n’existe pas (ou plus).</p>
      <a class="styled-button" routerLink="/catalogue">
        <span class="icon i-arrow-left" aria-hidden="true"></span>
        <span>Retour au catalogue</span>
      </a>
    </div>
  </div>

  <!-- ===== Share modal ===== -->
  <div *ngIf="shareOpen()" class="share-modal" (click)="closeShare()">
    <div class="share-dialog" role="dialog" aria-modal="true" aria-labelledby="share-title" id="share-dialog"
         (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h3 id="share-title">Partager ce livre</h3>
        <button type="button" class="close-btn" (click)="closeShare()" aria-label="Fermer">×</button>
      </div>

      <!-- Sharing options -->
      <ul class="share-grid">
        <li><a class="share-btn x"        [href]="shareHref('x')"        target="_blank" rel="noopener">
          <img loading="lazy" ngSrc="/assets/images/twitter.svg" width="26" height="26" alt="" /><span>X / Twitter</span></a></li>
        <li><a class="share-btn facebook" [href]="shareHref('facebook')" target="_blank" rel="noopener">
          <img loading="lazy" ngSrc="/assets/images/facebook.svg" width="26" height="26" alt="" /><span>Facebook</span></a></li>
        <li><a class="share-btn linkedin" [href]="shareHref('linkedin')" target="_blank" rel="noopener">
          <img loading="lazy" ngSrc="/assets/images/linkedin.svg" width="26" height="26" alt="" /><span>LinkedIn</span></a></li>
        <li><a class="share-btn whatsapp" [href]="shareHref('whatsapp')" target="_blank" rel="noopener">
          <img loading="lazy" ngSrc="/assets/images/whatsapp.svg" width="26" height="26" alt="" /><span>WhatsApp</span></a></li>
        <li><a class="share-btn email"    [href]="shareHref('email')">
          <img loading="lazy" ngSrc="/assets/images/icon-mail.svg" width="26" height="26" alt="" /><span>E-mail</span></a></li>
        <li><button type="button" class="share-btn copy" (click)="copyLink()">
          <img loading="lazy" ngSrc="/assets/images/share.svg" width="26" height="26" alt="" /><span>Copier le lien</span></button></li>
      </ul>
    </div>
  </div>

  <!-- ===== Toast notifications ===== -->
  <div class="toast-root" *ngIf="toast() as t" aria-live="polite">
    <div class="toast" [class.success]="t.type==='success'"
         [class.error]="t.type==='error'"
         [class.info]="t.type==='info'">
      <span class="t-icon" aria-hidden="true"></span>
      <div class="t-content">{{ t.message }}</div>
      <button class="t-close" (click)="toast.set(null)" aria-label="Fermer">×</button>
    </div>
  </div>
</section>
