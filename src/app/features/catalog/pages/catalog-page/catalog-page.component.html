<div class="catalog-page">

  <!-- =======================
       HERO : Background image + Title + Search bar
       ======================= -->
  <header class="catalog-hero">
    <img loading="lazy"
         ngSrc="assets/images/catalog-background.webp"
         width="1920" height="350" alt="Catalogue"
         class="hero-bg" fetchpriority="high" />

    <div class="page-gutter hero-inner">
      <!-- Page title -->
      <app-section-title class="hero-title" [title]="'Catalogue'"></app-section-title>

      <!-- Search bar with quick + advanced toggle -->
      <div class="searchbar-pill">
        <input
          type="search"
          placeholder="Tapez votre recherche…"
          [ngModel]="query()"
          (ngModelChange)="query.set($event)"
          (keyup.enter)="searchWithFilters()" />

        <button type="button" class="icon-btn" aria-label="Rechercher"
                (click)="searchWithFilters()">
          <img loading="lazy" ngSrc="assets/images/icon-search.svg" width="24" height="24" alt="" />
        </button>

        <!-- Advanced search toggle -->
        <label class="adv-toggle">
          <span>Recherche avancée</span>
          <input
            type="checkbox"
            [checked]="advanced()"
            (change)="advanced.set($any($event.target).checked)" />
          <i aria-hidden="true"></i>
        </label>
      </div>
    </div>
  </header>

  <!-- =======================
       Advanced filters form
       ======================= -->
  <form *ngIf="advanced()" class="filters page-gutter" (ngSubmit)="searchWithFilters()">
    <div class="grid">
      <!-- Each input updates a filter property -->
      <input [ngModel]="filters().isbn" (ngModelChange)="onFilterChange('isbn', $event)" name="isbn" placeholder="ISBN" />
      <input [ngModel]="filters().author" (ngModelChange)="onFilterChange('author', $event)" name="author" placeholder="Auteur" />
      <input
        [ngModel]="filters().date"
        (ngModelChange)="onFilterChange('date', $event)"
        name="date" type="date" placeholder="Date de publication"
        [ngClass]="{ 'is-empty': !filters().date }" />

      <!-- Genre dropdown -->
      <select
        [ngModel]="filters().genre"
        (ngModelChange)="onFilterChange('genre', $event)"
        name="genre"
        [ngClass]="{ 'is-empty': !filters().genre }">
        <option value="" disabled selected hidden>Genre</option>
        <option *ngFor="let g of genres()">{{ g }}</option>
      </select>

      <input [ngModel]="filters().tags" (ngModelChange)="onFilterChange('tags', $event)" name="tags" placeholder="Tags (séparés par des virgules)" />
      <input [ngModel]="filters().publisher" (ngModelChange)="onFilterChange('publisher', $event)" name="publisher" placeholder="Éditeur" />
      <input [ngModel]="filters().exclude" (ngModelChange)="onFilterChange('exclude', $event)" name="exclude" placeholder="Exclure des termes…" />

      <!-- Checkbox filter -->
      <label class="inline">
        <input type="checkbox" [ngModel]="filters().availableNow" (ngModelChange)="onFilterChange('availableNow', $event)" name="availableNow" />
        Disponible immédiatement
      </label>
    </div>

    <!-- Form actions -->
    <div class="action-row">
      <button type="button" class="styled-button secondary" (click)="resetAll()">Réinitialiser les filtres</button>
      <button type="submit" class="styled-button">Rechercher avec filtres</button>
    </div>
  </form>

  <!-- =======================
       NEW ARRIVALS SECTION
       ======================= -->
  <section class="section-block nouveautes above-separator page-gutter">
    <app-section-title [title]="'Nouveautés'"></app-section-title>

    <!-- Empty state if no new books -->
    <div *ngIf="visibleNouveautes().length === 0; else carouselTpl" class="callout-empty">
      <div class="lead">
        <img loading="lazy" ngSrc="assets/images/icon-empty.webp" width="28" height="28" alt="" />
        <strong>Pas de nouveautés pour le moment</strong>
      </div>
      <span>Revenez plus tard — cette section est mise à jour régulièrement.</span>
    </div>

    <!-- Carousel with books -->
    <ng-template #carouselTpl>
      <div class="carousel"
           (mouseenter)="pauseAutoplay(true)"
           (mouseleave)="pauseAutoplay(false)"
           (focusin)="pauseAutoplay(true)"
           (focusout)="pauseAutoplay(false)">

        <div class="viewport">
          <div class="track">
            <!-- Each book card -->
            <div class="col" *ngFor="let b of visibleNouveautes(); let i = index" [class.has-sep]="i>0">
              <app-book-card
                [showStatus]="true"
                [status]="bookStatus(b)"
                [title]="b.title"
                [image]="b.coverUrl || null"
                [description]="b.description || ''"
                [bookId]="b.id">
              </app-book-card>
            </div>
          </div>
        </div>

        <hr class="viewport-sep" />
      </div>
    </ng-template>
  </section>

  <!-- =======================
       RESULTS SECTION
       ======================= -->
  <section class="section-block page-gutter" aria-live="polite">
    <div class="meta">
      <!-- Number of results -->
      <span>Résultats affichés ({{ results().length }})</span>

      <!-- View mode switcher -->
      <div class="view-switch" role="tablist" aria-label="Changer le mode d'affichage">
        <button
          type="button"
          class="switch-btn"
          role="tab"
          [class.is-active]="viewMode() === 'grid'"
          [attr.aria-selected]="viewMode() === 'grid'"
          (click)="viewMode.set('grid')">
          Grille
        </button>
        <button
          type="button"
          class="switch-btn"
          role="tab"
          [class.is-active]="viewMode() === 'list'"
          [attr.aria-selected]="viewMode() === 'list'"
          (click)="viewMode.set('list')">
          Liste
        </button>
      </div>
    </div>

    <!-- Empty state -->
    <ng-template [ngIf]="results().length === 0" [ngIfElse]="resultsList">
      <div class="empty-state">
        <img loading="lazy" ngSrc="assets/images/icon-empty.webp" width="56" height="56" alt="" />
        <h3>Aucun résultat</h3>
        <p>Essayez un autre mot-clé ou ajustez vos filtres.</p>
        <div class="actions">
          <button type="button" class="styled-button secondary" (click)="resetAll()">Réinitialiser</button>
          <button type="button" class="styled-button" (click)="advanced.set(false)">Masquer les filtres</button>
        </div>
      </div>
    </ng-template>

    <!-- Results list (grid or list mode) -->
    <ng-template #resultsList>
      <div class="cards-grid" [class.is-list]="viewMode() === 'list'">
        <app-book-card
          *ngFor="let b of pagedResults()"
          [compact]="viewMode() === 'list'"
          [showStatus]="true"
          [status]="bookStatus(b)"
          [title]="b.title"
          [image]="b.coverUrl"
          [description]="b.description"
          [bookId]="b.id">
        </app-book-card>
      </div>

      <!-- Pagination controls -->
      <div class="pagination" *ngIf="totalPages().length > 1">
        <button (click)="prevPage()" [disabled]="pageIndex() === 0">‹</button>
        <button *ngFor="let i of totalPages()" [class.is-active]="i === pageIndex()" (click)="goToPage(i)">
          {{ i + 1 }}
        </button>
        <button (click)="nextPage()" [disabled]="pageIndex() === totalPages().length - 1">›</button>
      </div>
    </ng-template>
  </section>

</div>
