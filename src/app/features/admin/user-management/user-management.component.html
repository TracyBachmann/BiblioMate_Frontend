<div class="user-management-page">

  <!-- ===== HERO : Background + Title + Search ===== -->
  <header class="user-hero">
    <img loading="lazy"
         ngSrc="assets/images/catalog-background.webp"
         width="1920" height="350" alt="Gestion des utilisateurs"
         class="hero-bg" fetchpriority="high" />

    <div class="page-gutter hero-inner">
      <app-section-title class="hero-title" [title]="'Gestion des utilisateurs'"></app-section-title>

      <!-- Search bar -->
      <div class="searchbar-pill">
        <input
          type="search"
          placeholder="Rechercher un utilisateur..."
          [(ngModel)]="searchQuery"
          (input)="onSearch()" />

        <button type="button" class="icon-btn" aria-label="Rechercher" (click)="onSearch()">
          <img loading="lazy" ngSrc="assets/images/icon-search.svg" width="24" height="24" alt="" />
        </button>

        <!-- Advanced search toggle -->
        <label class="adv-toggle">
          <span>Filtres</span>
          <input type="checkbox" [checked]="advancedSearchOpen" (change)="toggleAdvancedSearch()" />
          <i aria-hidden="true"></i>
        </label>
      </div>
    </div>
  </header>

  <!-- ===== FILTERS ===== -->
  <div *ngIf="advancedSearchOpen" class="filters page-gutter">
    <div class="grid">
      <!-- Role filter -->
      <select [(ngModel)]="filterRole" (change)="applyFilters()" class="filter-select" [ngClass]="{ 'is-empty': !filterRole }">
        <option value="" disabled selected hidden>Rôle</option>
        <option value="User">Utilisateur</option>
        <option value="Librarian">Bibliothécaire</option>
        <option value="Admin">Administrateur</option>
      </select>

      <!-- Status filter -->
      <select [(ngModel)]="filterStatus" (change)="applyFilters()" class="filter-select" [ngClass]="{ 'is-empty': !filterStatus }">
        <option value="" disabled selected hidden>Statut</option>
        <option value="validated">Validés</option>
        <option value="pending">En attente</option>
      </select>
    </div>

    <!-- Action row -->
    <div class="action-row">
      <button type="button" class="styled-button secondary" (click)="resetFilters()">
        Réinitialiser les filtres
      </button>
      <button type="button" class="styled-button" (click)="applyFilters()">
        Appliquer
      </button>
    </div>
  </div>

  <!-- ===== RESULTS ===== -->
  <section class="section-block page-gutter">
    <div class="meta">
      <span>Utilisateurs affichés ({{ filteredUsers.length }})</span>
    </div>

    <!-- Loading state -->
    <div *ngIf="loading" class="empty-state">
      <p>Chargement des utilisateurs...</p>
    </div>

    <!-- Empty state -->
    <div *ngIf="!loading && filteredUsers.length === 0" class="empty-state">
      <img loading="lazy" ngSrc="assets/images/icon-empty.webp" width="56" height="56" alt="" />
      <h3>Aucun utilisateur trouvé</h3>
      <p>Essayez de modifier vos filtres ou votre recherche.</p>
      <div class="actions">
        <button type="button" class="styled-button secondary" (click)="resetFilters()">
          Réinitialiser
        </button>
      </div>
    </div>

    <!-- Data table -->
    <div *ngIf="!loading && filteredUsers.length > 0" class="table-container">
      <app-data-table
        [columns]="columns"
        [data]="filteredUsers"
        [actions]="tableActions"
      ></app-data-table>
    </div>
  </section>

  <!-- ===== TOAST ===== -->
  <div class="toast-root" *ngIf="toast" aria-live="polite">
    <div class="toast" [class.success]="toast.type==='success'"
         [class.error]="toast.type==='error'"
         [class.info]="toast.type==='info'">
      <span class="t-icon" aria-hidden="true"></span>
      <div class="t-content">{{ toast.message }}</div>
      <button class="t-close" (click)="toast = null" aria-label="Fermer">×</button>
    </div>
  </div>

  <!-- ===== MODAL ===== -->
  <div *ngIf="confirmModal" class="modal-overlay" (click)="closeConfirmModal()">
    <div class="modal-dialog" role="dialog" aria-modal="true" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ confirmModal.title }}</h3>
        <button type="button" class="close-btn" (click)="closeConfirmModal()" aria-label="Fermer">×</button>
      </div>
      <div class="modal-body">
        <p>{{ confirmModal.message }}</p>

        <!-- Textarea pour le rejet -->
        <textarea
          *ngIf="confirmModal.needsReason"
          [(ngModel)]="rejectionReason"
          placeholder="Raison du rejet (optionnel)"
          class="reason-input"
          rows="3"
        ></textarea>

        <!-- Dropdown pour le changement de rôle -->
        <select
          *ngIf="confirmModal.isRoleChange"
          [(ngModel)]="selectedRole"
          class="role-select"
        >
          <option value="" disabled selected>Sélectionnez un rôle</option>
          <option value="User" [selected]="confirmModal.currentRole === 'User'">Utilisateur</option>
          <option value="Librarian" [selected]="confirmModal.currentRole === 'Librarian'">Bibliothécaire</option>
          <option value="Admin" [selected]="confirmModal.currentRole === 'Admin'">Administrateur</option>
        </select>
      </div>
      <div class="modal-footer">
        <button type="button" class="styled-button secondary" (click)="closeConfirmModal()">
          Annuler
        </button>
        <button
          type="button"
          class="styled-button"
          [class.danger]="confirmModal.isDanger"
          (click)="confirmAction()"
        >
          {{ confirmModal.confirmText }}
        </button>
      </div>
    </div>
  </div>

</div>
