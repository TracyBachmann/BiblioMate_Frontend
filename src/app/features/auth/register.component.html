<div class="login-wrapper">
  <div class="login-page">
    <img
      ngSrc="assets/images/hero-background.png"
      width="1920"
      height="1080"
      alt="Bibliothèque de Montferrand"
      class="login-background"
      fetchpriority="high"
      priority
    />

    <form [formGroup]="registerForm" (ngSubmit)="submit()" class="login-form">
      <h1>Créer votre compte</h1>

      <p class="login-subtext">
        Vous avez un compte ?
        <a routerLink="/connexion">Connectez-vous</a>
      </p>

      <!-- Stepper -->
      <div class="stepper">
        <span [class.active]="step>=1">1</span>
        <span [class.active]="step>=2">2</span>
        <span [class.active]="step>=3">3</span>
        <span [class.active]="step>=4">4</span>
        <span [class.active]="step>=5">5</span>
      </div>

      <!-- ÉTAPE 1 : identité -->
      <ng-container *ngIf="step === 1">
        <div class="form-field">
          <input
            type="text"
            placeholder="Nom"
            formControlName="lastName"
            [class.invalid]="hasError('lastName')"
          />
          <div class="error-text" *ngIf="hasError('lastName')">
            {{ getErrorMessage('lastName') }}
          </div>
        </div>

        <div class="form-field">
          <input
            type="text"
            placeholder="Prénom"
            formControlName="firstName"
            [class.invalid]="hasError('firstName')"
          />
          <div class="error-text" *ngIf="hasError('firstName')">
            {{ getErrorMessage('firstName') }}
          </div>
        </div>

        <div class="form-field">
          <input
            type="email"
            placeholder="Adresse de messagerie"
            formControlName="email"
            [class.invalid]="hasError('email')"
          />
          <div class="error-text" *ngIf="hasError('email')">
            {{ getErrorMessage('email') }}
          </div>
        </div>
      </ng-container>

      <!-- ÉTAPE 2 : contact -->
      <ng-container *ngIf="step === 2">
        <div class="form-field">
          <input
            type="tel"
            placeholder="Téléphone"
            formControlName="phone"
            [class.invalid]="hasError('phone')"
          />
          <div class="error-text" *ngIf="hasError('phone')">
            {{ getErrorMessage('phone') }}
          </div>
        </div>

        <div class="form-field">
          <input
            type="text"
            placeholder="Adresse 1"
            formControlName="address1"
            [class.invalid]="hasError('address1')"
          />
          <div class="error-text" *ngIf="hasError('address1')">
            {{ getErrorMessage('address1') }}
          </div>
        </div>

        <div class="form-field">
          <input
            type="text"
            placeholder="Adresse 2 (facultatif)"
            formControlName="address2"
          />
        </div>
      </ng-container>

      <!-- ÉTAPE 3 : sécurité + date de naissance -->
      <ng-container *ngIf="step === 3">
        <div class="form-field">
          <input
            type="date"
            placeholder="Date de naissance"
            formControlName="dateOfBirth"
          />
          <div class="hint">Facultatif — utilisé pour des recommandations adaptées.</div>
        </div>

        <div class="form-field">
          <input
            type="password"
            placeholder="Mot de passe"
            formControlName="password"
            [class.invalid]="hasError('password') || registerForm.hasError('passwordMismatch')"
          />
          <div class="error-text" *ngIf="hasError('password')">
            {{ getErrorMessage('password') }}
          </div>
        </div>

        <div class="form-field">
          <input
            type="password"
            placeholder="Confirmation du mot de passe"
            formControlName="confirmPassword"
            [class.invalid]="hasError('confirmPassword') || registerForm.hasError('passwordMismatch')"
          />
          <div class="error-text" *ngIf="hasError('confirmPassword') || registerForm.hasError('passwordMismatch')">
            {{ getErrorMessage('confirmPassword') }}
          </div>
        </div>
      </ng-container>

      <!-- ÉTAPE 4 : image de profil (facultatif) -->
      <ng-container *ngIf="step === 4">
        <div class="dropzone" (click)="fileInput.click()">
          <input
            #fileInput
            type="file"
            accept="image/*"
            (change)="onFileSelected($event)"
            hidden
          />
          <ng-container *ngIf="!previewUrl; else preview">
            <p>Cliquer pour choisir une image (facultatif)</p>
            <small>PNG / JPG • &lt; 5 Mo</small>
          </ng-container>
          <ng-template #preview>
            <img [src]="previewUrl" alt="Aperçu" />
            <button type="button" class="tiny" (click)="clearImage($event)">Retirer</button>
          </ng-template>
        </div>
        <div class="hint">L’image est optionnelle. Elle n’est pas encore téléversée : on enverra juste un champ vide côté API.</div>
      </ng-container>

      <!-- ÉTAPE 5 : genres + CGU -->
      <ng-container *ngIf="step === 5">
        <div class="form-field">
          <label>Genres favoris (facultatif)</label>
          <div class="chips">
            <button
              type="button"
              class="chip"
              *ngFor="let g of genres"
              [class.selected]="favoriteGenreIds.value?.includes(g.id)"
              (click)="toggleGenre(g.id)"
            >
              {{ g.name }}
            </button>
          </div>
        </div>

        <div class="checkbox-line">
          <input id="accept" type="checkbox" formControlName="acceptTerms" />
          <label for="accept">
            J’accepte les conditions d’utilisation.
          </label>
        </div>
        <div class="error-text" *ngIf="hasError('acceptTerms')">
          Veuillez accepter les conditions d’utilisation.
        </div>
      </ng-container>

      <!-- NAV -->
      <div class="wizard-nav">
        <button type="button" class="styled-button secondary" (click)="prev()" [disabled]="step===1">
          Étape précédente
        </button>

        <button *ngIf="step<5" type="button" class="styled-button" (click)="next()">
          Étape suivante
        </button>

        <button
          *ngIf="step===5"
          type="submit"
          class="styled-button"
          [disabled]="isSubmitting"
          [class.loading]="isSubmitting"
        >
          <span *ngIf="!isSubmitting">S'inscrire à BiblioMate</span>
          <span *ngIf="isSubmitting">Envoi en cours...</span>
        </button>
      </div>

      <div class="error-message" *ngIf="errorMessage">{{ errorMessage }}</div>
      <div class="success-message" *ngIf="successMessage">{{ successMessage }}</div>
    </form>
  </div>
</div>
