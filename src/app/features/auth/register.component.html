<div class="login-wrapper">
  <div class="login-page">
    <!-- Background image -->
    <img
      ngSrc="assets/images/hero-background.png"
      width="1920"
      height="1080"
      alt="Bibliothèque de Montferrand"
      class="login-background"
      fetchpriority="high"
      priority
    />

    <!-- Registration form with stepper -->
    <form [formGroup]="registerForm" (ngSubmit)="submit()" class="login-form">
      <!-- Step 0: Google Sign-up button (currently disabled) -->
      <div class="button-wrapper alt-spacing">
        <button type="button" class="google-button styled-button" disabled>
          <img
            ngSrc="assets/images/icon-google.svg"
            width="24"
            height="24"
            alt="Google"
            fetchpriority="low"
          />
          S'inscrire avec Google
        </button>
      </div>

      <!-- Divider between Google and manual form -->
      <div class="divider"><span>OU</span></div>

      <!-- Stepper showing progression (1 to 5) -->
      <div class="stepper stepper-lg">
        <span [class.active]="step>=1">1</span><i class="sep" aria-hidden="true"></i>
        <span [class.active]="step>=2">2</span><i class="sep" aria-hidden="true"></i>
        <span [class.active]="step>=3">3</span><i class="sep" aria-hidden="true"></i>
        <span [class.active]="step>=4">4</span><i class="sep" aria-hidden="true"></i>
        <span [class.active]="step>=5">5</span>
      </div>

      <!-- Form title -->
      <h1>Créer votre compte</h1>

      <!-- Link to login if user already has an account -->
      <p class="login-subtext">
        Vous avez un compte ?
        <a routerLink="/connexion">Connectez-vous</a>
      </p>

      <!-- Step 1: Basic info (name, first name, email) -->
      <ng-container *ngIf="step === 1">
        <div class="form-field">
          <input
            type="text"
            placeholder="Nom"
            formControlName="lastName"
            [class.invalid]="hasError('lastName')"
          />
          <div class="error-text" *ngIf="hasError('lastName')">
            {{ getErrorMessage('lastName') }}
          </div>
        </div>

        <div class="form-field">
          <input
            type="text"
            placeholder="Prénom"
            formControlName="firstName"
            [class.invalid]="hasError('firstName')"
          />
          <div class="error-text" *ngIf="hasError('firstName')">
            {{ getErrorMessage('firstName') }}
          </div>
        </div>

        <div class="form-field">
          <input
            type="email"
            placeholder="Adresse de messagerie"
            formControlName="email"
            [class.invalid]="hasError('email')"
          />
          <div class="error-text" *ngIf="hasError('email')">
            {{ getErrorMessage('email') }}
          </div>
        </div>
      </ng-container>

      <!-- Step 2: Contact info and address -->
      <ng-container *ngIf="step === 2">
        <div class="form-field">
          <input
            type="tel"
            placeholder="Téléphone"
            formControlName="phone"
            [class.invalid]="hasError('phone')"
          />
          <div class="error-text" *ngIf="hasError('phone')">
            {{ getErrorMessage('phone') }}
          </div>
        </div>

        <div class="form-field">
          <input
            type="text"
            placeholder="Adresse 1"
            formControlName="address1"
            [class.invalid]="hasError('address1')"
          />
          <div class="error-text" *ngIf="hasError('address1')">
            {{ getErrorMessage('address1') }}
          </div>
        </div>

        <div class="form-field">
          <input
            type="text"
            placeholder="Adresse 2 (facultatif)"
            formControlName="address2"
          />
        </div>
      </ng-container>

      <!-- Step 3: Date of birth and password setup -->
      <ng-container *ngIf="step === 3">
        <div class="form-field">
          <input type="date" placeholder="Date de naissance" formControlName="dateOfBirth" />
          <div class="hint">Facultatif — utilisé pour des recommandations adaptées.</div>
        </div>

        <div class="form-field">
          <input
            type="password"
            placeholder="Mot de passe"
            formControlName="password"
            [class.invalid]="hasError('password') || registerForm.hasError('passwordMismatch')"
          />
          <div class="error-text" *ngIf="hasError('password')">
            {{ getErrorMessage('password') }}
          </div>
        </div>

        <div class="form-field">
          <input
            type="password"
            placeholder="Confirmation du mot de passe"
            formControlName="confirmPassword"
            [class.invalid]="hasError('confirmPassword') || registerForm.hasError('passwordMismatch')"
          />
          <div class="error-text" *ngIf="hasError('confirmPassword') || registerForm.hasError('passwordMismatch')">
            {{ getErrorMessage('confirmPassword') }}
          </div>
        </div>
      </ng-container>

      <!-- Step 4: Avatar upload -->
      <ng-container *ngIf="step === 4">
        <div class="dropzone" (click)="fileInput.click()">
          <input #fileInput type="file" accept="image/*" (change)="onFileSelected($event)" hidden />
          <ng-container *ngIf="!previewUrl">
            <p>Cliquer pour choisir une image (facultatif)</p>
            <small>PNG / JPG • &lt; 5 Mo</small>
          </ng-container>
          <ng-container *ngIf="previewUrl as url">
            <img [ngSrc]="url" width="256" height="256" alt="Aperçu" decoding="async" />
            <button type="button" class="tiny" (click)="clearImage($event)">Retirer</button>
          </ng-container>
        </div>
        <div class="hint">L’image est optionnelle. Rien n’est téléversé tant que l’API n’est pas câblée.</div>
      </ng-container>

      <!-- Step 5: Favorite genres and terms acceptance -->
      <ng-container *ngIf="step === 5">
        <div class="form-field">
          <label>Genres favoris (facultatif)</label>
          <div class="chips">
            <button
              type="button"
              class="chip"
              *ngFor="let g of genres"
              [class.selected]="favoriteGenreIds.value.includes(g.id)"
              (click)="toggleGenre(g.id)"
            >
              {{ g.name }}
            </button>
          </div>
        </div>

        <!-- Terms and conditions -->
        <div class="checkbox-line">
          <input id="accept" type="checkbox" formControlName="acceptTerms" />
          <label for="accept">J’accepte les conditions d’utilisation.</label>
        </div>
        <div class="error-text" *ngIf="hasError('acceptTerms')">
          Veuillez accepter les conditions d’utilisation.
        </div>
      </ng-container>

      <!-- Navigation buttons (previous/next/submit) -->
      <div class="wizard-nav">
        <button *ngIf="step>1" type="button" class="styled-button secondary" (click)="prev()">
          Étape précédente
        </button>

        <button *ngIf="step<5" type="button" class="styled-button" (click)="next()">
          Étape suivante
        </button>

        <button
          *ngIf="step===5"
          type="submit"
          class="styled-button"
          [disabled]="isSubmitting"
          [class.loading]="isSubmitting"
        >
          <span *ngIf="!isSubmitting">S'inscrire à BiblioMate</span>
          <span *ngIf="isSubmitting">Envoi en cours...</span>
        </button>
      </div>

      <!-- Error and success messages -->
      <div class="error-message" *ngIf="errorMessage">{{ errorMessage }}</div>
      <div class="success-message" *ngIf="successMessage">{{ successMessage }}</div>
    </form>
  </div>
</div>
