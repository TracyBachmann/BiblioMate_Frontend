<!-- ============================================================
     Header Component Template
     - Displays site logo, navigation icons, and drawers
     - Contains:
       * Logo and menu toggle
       * Navigation icons (search, contact, account)
       * Drawer menu (sidebar navigation)
       * Drawer search (search panel with advanced filters)
     ============================================================ -->

<header class="header">
  <!-- ========================
       Top bar: Logo + menu toggle
       ======================== -->
  <div class="header__top">
    <!-- Button to toggle side menu -->
    <button
      #menuToggleButton
      class="header__menu-toggle"
      (click)="toggleMenu()"
      aria-label="Ouvrir le menu latéral"
      [attr.aria-expanded]="isMenuOpen">
      <img ngSrc="assets/images/icon-menu.svg" alt="Menu" width="60" height="60" />
    </button>

    <!-- Logo linking to homepage -->
    <a routerLink="/">
      <img
        class="header__logo"
        ngSrc="assets/images/logo.svg"
        alt="Logo BiblioMate"
        width="500"
        height="382"
      />
    </a>
  </div>

  <!-- ========================
       Navigation icons
       ======================== -->
  <nav class="header__nav">
    <!-- Search icon: toggles search drawer -->
    <button
      #searchToggleBtn
      type="button"
      class="header__nav-item search"
      aria-label="Recherche"
      (click)="toggleSearch()">
      <img ngSrc="assets/images/icon-search.svg" alt="Recherche" width="60" height="60" />
    </button>

    <!-- Contact icon -->
    <a class="header__nav-item contact" routerLink="/contact" aria-label="Contact">
      <img ngSrc="assets/images/icon-contact.svg" alt="Contact" width="60" height="60" />
    </a>

    <!-- Account icon: destination depends on authentication state -->
    <a class="header__nav-item user"
       [routerLink]="(auth.isAuthenticated$ | async) ? '/espace' : '/connexion'"
       aria-label="Mon compte">
      <img ngSrc="assets/images/icon-user.svg" alt="Mon compte" width="60" height="60" />
    </a>
  </nav>

  <!-- ========================
       Side drawer menu
       - Accessible via menu toggle
       - Displays navigation links based on authentication state
       ======================== -->
  <aside class="header__drawer"
         role="dialog"
         aria-modal="true"
         aria-labelledby="drawer-title"
         [class.is-visible]="isMenuOpen"
         (keydown)="handleKeyDown($event)">
    <h2 id="drawer-title" class="visually-hidden">Menu principal</h2>

    <!-- Close button -->
    <button class="header__drawer__close" (click)="closeMenu()" aria-label="Fermer le menu">
      <img ngSrc="assets/images/icon-fermer.svg" alt="Fermer" height="39" width="39" />
    </button>

    <nav>
      <!-- Home link -->
      <a routerLink="/"
         routerLinkActive="active"
         [routerLinkActiveOptions]="{ exact: true }"
         (click)="closeMenu()"
         aria-current="page">
        Accueil
      </a>

      <!-- Catalog link -->
      <a routerLink="/catalogue"
         routerLinkActive="active"
         (click)="closeMenu()">
        Catalogue
      </a>

      <!-- Non-authenticated state: login option -->
      <ng-container *ngIf="(auth.isAuthenticated$ | async) === false">
        <a routerLink="/connexion"
           routerLinkActive="active"
           (click)="closeMenu()">
          Se connecter
        </a>
        <hr />
      </ng-container>

      <!-- Authenticated state: personal space and admin links -->
      <ng-container *ngIf="auth.isAuthenticated$ | async">
        <a routerLink="/espace"
           routerLinkActive="active"
           (click)="closeMenu()">
          Espace personnel
        </a>

        <!-- Librarian section (currently commented out) -->
        <!--
        <ng-container *ngIf="(auth.role$ | async) === 'Librarian'">
          <a routerLink="/gestion"
             routerLinkActive="active"
             (click)="closeMenu()">
            Gestion
          </a>
        </ng-container>
        -->

        <!-- Admin-only links -->
        <ng-container *ngIf="(auth.role$ | async) === 'Admin'">
          <a routerLink="/admin"
             routerLinkActive="active"
             (click)="closeMenu()">
            Administration
          </a>
          <a routerLink="/rapports"
             routerLinkActive="active"
             (click)="closeMenu()">
            Rapports
          </a>
        </ng-container>

        <!-- Logout link -->
        <a (click)="auth.logout()">Se déconnecter</a>
        <hr />
      </ng-container>

      <!-- Additional static pages -->
      <a routerLink="/contact"
         routerLinkActive="active"
         (click)="closeMenu()">
        Contact
      </a>

      <a routerLink="/a-propos"
         routerLinkActive="active"
         (click)="closeMenu()">
        À propos
      </a>

      <a routerLink="/faq"
         routerLinkActive="active"
         (click)="closeMenu()">
        FAQ
      </a>

      <a routerLink="/mentions-legales"
         routerLinkActive="active"
         (click)="closeMenu()">
        Mentions légales
      </a>
    </nav>
  </aside>

  <!-- ========================
       Search drawer
       - Accessible via search icon
       - Contains search bar and advanced filters
       ======================== -->
  <aside class="header__search"
         role="dialog"
         aria-modal="true"
         aria-labelledby="search-title"
         [class.is-visible]="isSearchOpen"
         (keydown)="handleSearchKeyDown($event)">
    <h2 id="search-title" class="visually-hidden">Recherche</h2>

    <!-- Close button -->
    <button class="header__search__close" (click)="closeSearch()" aria-label="Fermer la recherche">
      <img ngSrc="assets/images/icon-fermer.svg" alt="" height="39" width="39" />
    </button>

    <!-- Search bar with advanced toggle -->
    <div class="page-gutter hero-inner">
      <div class="searchbar-pill">
        <input
          #searchFirstInput
          type="search"
          placeholder="Tapez votre recherche..."
          [ngModel]="query()"
          (ngModelChange)="onQueryChange($event)"
          (keyup.enter)="applyNow()" />

        <button type="button" class="icon-btn" aria-label="Rechercher" (click)="applyNow()">
          <img ngSrc="assets/images/icon-search.svg" width="24" height="24" alt="" />
        </button>

        <label class="adv-toggle">
          <span>Recherche avancée</span>
          <input type="checkbox"
                 [checked]="advanced()"
                 (change)="setAdvanced($any($event.target).checked)" />
          <i aria-hidden="true"></i>
        </label>
      </div>
    </div>

    <!-- Hint text -->
    <p class="search-hint page-gutter">
      <img ngSrc="assets/images/alerte.svg" alt="" class="icon-alert"  height="39" width="39"/>
      Vos recherches s’ouvriront dans le <a routerLink="/catalogue">catalogue.</a>
    </p>

    <!-- Advanced filters form -->
    <form *ngIf="advanced()" class="filters page-gutter" (ngSubmit)="applyNow()">
      <div class="grid">
        <input [ngModel]="filters().isbn"      (ngModelChange)="onFilterChange('isbn', $event)"      name="isbn"      placeholder="ISBN" />
        <input [ngModel]="filters().author"    (ngModelChange)="onFilterChange('author', $event)"    name="author"    placeholder="Auteur" />
        <input [ngModel]="filters().date"      (ngModelChange)="onFilterChange('date', $event)"      name="date"      type="date" placeholder="Date de publication"
               [ngClass]="{ 'is-empty': !filters().date }" />
        <select [ngModel]="filters().genre"    (ngModelChange)="onFilterChange('genre', $event)"     name="genre"
                [ngClass]="{ 'is-empty': !filters().genre }">
          <option value="" disabled selected hidden>Genre</option>
          <option *ngFor="let g of genres()">{{ g }}</option>
        </select>
        <input [ngModel]="filters().tags"      (ngModelChange)="onFilterChange('tags', $event)"      name="tags"      placeholder="Tags (séparés par des virgules)" />
        <input [ngModel]="filters().publisher" (ngModelChange)="onFilterChange('publisher', $event)" name="publisher" placeholder="Éditeur" />
        <input [ngModel]="filters().exclude"   (ngModelChange)="onFilterChange('exclude', $event)"   name="exclude"   placeholder="Exclure de la recherche..." />
        <label class="inline">
          <input type="checkbox"
                 [ngModel]="filters().availableNow"
                 (ngModelChange)="onFilterChange('availableNow', $event)"
                 name="availableNow" />
          Est disponible immédiatement
        </label>
      </div>

      <!-- Action buttons -->
      <div class="action-row">
        <button type="button" class="styled-button secondary" (click)="resetAll()">Réinitialiser les filtres</button>
        <button type="submit" class="styled-button">Rechercher avec ces filtres</button>
      </div>
    </form>
  </aside>
</header>


